<!-- Chosen Palette: Apple Weather (Dynamic) -->
<!-- Application Structure Plan: Standalone HTML page. Enhanced Apple Weather UI with PWA support and iframe embedding script. -->
<!-- Visualization & Content Choices: Includes <link rel="manifest"> for PWA. Includes the 'sendHeight()' script before </body> for seamless iframe embedding. Fixed the 'getDirection' bug (now 'getWindDirection'). All other Apple UI logic remains. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªùi ti·∫øt (Phong c√°ch Apple Pro)</title>
    
    <!-- KHAI B√ÅO PWA (Progressive Web App) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a4e9b">
    
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- T·∫£i Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- CSS t√πy ch·ªânh cho giao di·ªán Apple -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* N·ªÅn m·∫∑c ƒë·ªãnh (s·∫Ω b·ªã JS ghi ƒë√®) */
            background-color: #0a4e9b;
            background-image: linear-gradient(170deg, #4a90e2 0%, #0a4e9b 70%, #05264c 100%),
                              radial-gradient(circle at 50% -20%, rgba(255, 255, 230, 0.3), rgba(255, 255, 230, 0) 50%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
            padding: 1.5rem 0.5rem;
            /* Th√™m hi·ªáu ·ª©ng chuy·ªÉn n·ªÅn m∆∞·ª£t m√† */
            transition: background-image 1s ease-in-out;
            margin: 0; /* ƒê·∫£m b·∫£o kh√¥ng c√≥ margin cho iframe */
        }
        
        /* Tinh ch·ªânh th·∫ª "K√≠nh m·ªù" */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 20px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .hourly-forecast-container::-webkit-scrollbar { display: none; }
        .hourly-forecast-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        .weather-icon-main { font-size: 5rem; line-height: 1; }
        .weather-icon-hourly { font-size: 2rem; line-height: 1; }
        .weather-icon-daily { font-size: 1.75rem; line-height: 1; }

        /* Ph√¢n c√°ch trong danh s√°ch */
        .list-divider {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .list-divider:last-child {
            border-bottom: none;
        }

        /* THANH NHI·ªÜT ƒê·ªò */
        .temp-bar-track {
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            position: relative;
            margin-top: 4px;
        }
        .temp-bar-thumb {
            height: 100%;
            border-radius: 2px;
            position: absolute;
            background-image: linear-gradient(to right, #4ade80, #facc15, #f97316);
        }

    </style>
</head>
<body class="p-4">

    <!-- ƒê√¢y l√† to√†n b·ªô HTML c·ªßa widget -->
    <div id="loading" class="text-center p-10">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg text-gray-200 mt-4">ƒêang t·∫£i d·ªØ li·ªáu (Open-Meteo)...</p>
    </div>

    <!-- Container ch√≠nh -->
    <div id="weather-app" class="max-w-md mx-auto hidden">

        <!-- TH·∫∫ TH√îNG TIN CH√çNH -->
        <div class="text-center mb-4 pt-4">
            <h1 id="city-name" class="text-3xl font-medium">H·∫£i Ph√≤ng</h1>
            <p id="current-temp" class="text-8xl font-thin tracking-tight my-1">30¬∞</p>
            <p id="current-desc" class="text-2xl font-regular text-gray-200">Tr·ªùi quang</p>
            <p id="current-high-low" class="text-xl font-medium mt-1">Cao: 32¬∞ / Th·∫•p: 25¬∞</p>
            <p id="current-time" class="text-lg font-medium text-gray-300 mt-2">--:--:--</p>
        </div>

        <!-- TH·∫∫ D·ª∞ B√ÅO H√ÄNG GI·ªú -->
        <div class="glass-card">
            <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-3">D·ª± b√°o h√†ng gi·ªù</h2>
            <div id="hourly-forecast-container" class="flex overflow-x-auto -mx-1">
                <!-- JS ch√®n d·ªØ li·ªáu v√†o ƒë√¢y -->
            </div>
        </div>

        <!-- TH·∫∫ D·ª∞ B√ÅO H√ÄNG NG√ÄY -->
        <div class="glass-card">
            <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-2">D·ª± b√°o 5 ng√†y</h2>
            <ul id="daily-forecast-container" class="space-y-0">
                <!-- JS ch√®n d·ªØ li·ªáu v√†o ƒë√¢y -->
            </ul>
        </div>
        
        <!-- TH·∫∫ CHI TI·∫æT (GRID) -->
        <div class="grid grid-cols-2 gap-4">
            <div class="glass-card !mb-0">
                <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-2">C·∫£m gi√°c nh∆∞</h2>
                <p id="current-feels-like" class="text-4xl font-light">35¬∞</p>
            </div>
            <div class="glass-card !mb-0">
                <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-2">ƒê·ªô ·∫©m</h2>
                <p id="current-humidity" class="text-4xl font-light">75<span class="text-2xl">%</span></p>
            </div>
            <div class="glass-card !mb-0">
                <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-2">Gi√≥</h2>
                <p id="current-wind-speed" class="text-2xl font-light">10 <span class="text-lg">km/h</span></p>
                <p id="current-wind-dir" class="text-xl font-light">H∆∞·ªõng B</p>
            </div>
            <div class="glass-card !mb-0">
                <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-2">L∆∞·ª£ng m∆∞a (1h)</h2>
                <p id="current-rain" class="text-2xl font-light">0.0 <span class="text-lg">mm</span></p>
            </div>
            <div class="glass-card !mb-0">
                <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-2">M·∫∑t tr·ªùi m·ªçc</h2>
                <p id="current-sunrise" class="text-4xl font-light">05:30</p>
            </div>
            <div class="glass-card !mb-0">
                <h2 class="text-xs text-gray-300 font-medium uppercase tracking-wider mb-2">M·∫∑t tr·ªùi l·∫∑n</h2>
                <p id="current-sunset" class="text-4xl font-light">18:15</p>
            </div>
        </div>
    </div>

    <!-- To√†n b·ªô JavaScript logic -->
    <script>
        // Ch·∫°y h√†m fetch khi trang ƒë√£ t·∫£i xong
        window.addEventListener('DOMContentLoaded', () => {
            fetchWeatherData();
            updateClock(); // B·∫Øt ƒë·∫ßu ƒë·ªìng h·ªì ngay l·∫≠p t·ª©c
            setInterval(updateClock, 1000); // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì m·ªói gi√¢y
        });

        // H√†m tr·ª£ gi√∫p ƒë·ªÉ l·∫•y element
        function $(id) {
            return document.getElementById(id);
        }

        // H√ÄM: C·∫≠p nh·∫≠t ƒë·ªìng h·ªì
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            const timeEl = $('current-time');
            if (timeEl) {
                timeEl.textContent = timeString;
            }
        }
        
        // DANH S√ÅCH N·ªÄN ƒê·ªòNG
        const backgrounds = {
            day_clear: 'linear-gradient(170deg, #4a90e2 0%, #0a4e9b 70%, #05264c 100%), radial-gradient(circle at 50% -20%, rgba(255, 255, 230, 0.3), rgba(255, 255, 230, 0) 50%)',
            night_clear: 'linear-gradient(170deg, #0d1a2a 0%, #0a2a4c 70%, #000 100%), radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0) 20%)',
            cloudy: 'linear-gradient(170deg, #899bab 0%, #516171 70%, #3a444d 100%)',
            rain: 'linear-gradient(170deg, #5c6a79 0%, #3e4852 70%, #2a3036 100%)'
        };

        // B·∫¢N ƒê·ªí D·ªäCH TH·ªúI TI·∫æT (WMO)
        function getWeatherInfo(code) {
            const map = {
                0: { desc: 'Tr·ªùi quang', icon: '‚òÄÔ∏è', category: 'clear' },
                1: { desc: 'Tr·ªùi quang', icon: '‚òÄÔ∏è', category: 'clear' },
                2: { desc: '√çt m√¢y', icon: 'üå§Ô∏è', category: 'cloudy' },
                3: { desc: 'Nhi·ªÅu m√¢y', icon: '‚òÅÔ∏è', category: 'cloudy' },
                45: { desc: 'S∆∞∆°ng m√π', icon: 'üå´Ô∏è', category: 'cloudy' },
                48: { desc: 'S∆∞∆°ng m√π d√†y', icon: 'üå´Ô∏è', category: 'cloudy' },
                51: { desc: 'M∆∞a ph√πn nh·∫π', icon: 'üå¶Ô∏è', category: 'rain' },
                53: { desc: 'M∆∞a ph√πn', icon: 'üå¶Ô∏è', category: 'rain' },
                55: { desc: 'M∆∞a ph√πn d√†y', icon: 'üå¶Ô∏è', category: 'rain' },
                56: { desc: 'M∆∞a ph√πn bƒÉng', icon: 'ü•∂', category: 'rain' },
                57: { desc: 'M∆∞a ph√πn bƒÉng', icon: 'ü•∂', category: 'rain' },
                61: { desc: 'M∆∞a nh·∫π', icon: 'üåßÔ∏è', category: 'rain' },
                63: { desc: 'M∆∞a v·ª´a', icon: 'üåßÔ∏è', category: 'rain' },
                65: { desc: 'M∆∞a to', icon: 'üåßÔ∏è', category: 'rain' },
                66: { desc: 'M∆∞a bƒÉng', icon: 'ü•∂', category: 'rain' },
                67: { desc: 'M∆∞a bƒÉng', icon: 'ü•∂', category: 'rain' },
                71: { desc: 'Tuy·∫øt r∆°i nh·∫π', icon: 'üå®Ô∏è', category: 'rain' },
                73: { desc: 'Tuy·∫øt r∆°i v·ª´a', icon: 'üå®Ô∏è', category: 'rain' },
                75: { desc: 'Tuy·∫øt r∆°i d√†y', icon: 'üå®Ô∏è', category: 'rain' },
                77: { desc: 'H·∫°t tuy·∫øt', icon: 'üå®Ô∏è', category: 'rain' },
                80: { desc: 'M∆∞a r√†o nh·∫π', icon: 'üåßÔ∏è', category: 'rain' },
                81: { desc: 'M∆∞a r√†o v·ª´a', icon: 'üåßÔ∏è', category: 'rain' },
                82: { desc: 'M∆∞a r√†o to', icon: 'üåßÔ∏è', category: 'rain' },
                85: { desc: 'M∆∞a tuy·∫øt', icon: 'üå®Ô∏è', category: 'rain' },
                86: { desc: 'M∆∞a tuy·∫øt', icon: 'üå®Ô∏è', category: 'rain' },
                95: { desc: 'D√¥ng', icon: '‚õàÔ∏è', category: 'rain' },
                96: { desc: 'D√¥ng (m∆∞a ƒë√°)', icon: '‚õàÔ∏è', category: 'rain' },
                99: { desc: 'D√¥ng (m∆∞a ƒë√°)', icon: '‚õàÔ∏è', category: 'rain' }
            };
            return map[code] || { desc: 'Kh√¥ng r√µ', icon: 'ü§∑', category: 'cloudy' };
        }

        // H√ÄM L·∫§Y H∆Ø·ªöNG GI√ì
        function getWindDirection(deg) {
            const directions = ['B', 'BƒêB', 'ƒêB', 'ƒêƒêB', 'ƒê', 'ƒêƒêN', 'ƒêN', 'NƒêN', 'N', 'NƒêN', 'TN', 'TNN', 'T', 'TBB', 'TB', 'BTT'];
            const index = Math.round((deg % 360) / 22.5);
            return directions[index % 16];
        }

        // C√ÅC H√ÄM ƒê·ªäNH D·∫†NG TH·ªúI GIAN
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatHour(dateString) {
             const date = new Date(dateString);
             return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }); 
        }

        function formatDay(dateString) {
            const date = new Date(dateString);
            const dayNames = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
            return dayNames[date.getDay()];
        }

        // --- LOGIC CH√çNH ---
        function fetchWeatherData() {
            const lat = 20.8447;
            const lon = 106.6881;
            const timezone = 'Asia/Ho_Chi_Minh';
            
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=is_day,temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,precipitation_probability,precipitation,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum,precipitation_probability_max&timezone=${timezone}`;

            const loadingEl = $('loading');
            const appEl = $('weather-app');

            loadingEl.style.display = 'block';
            appEl.style.display = 'none';

            fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Open-Meteo.');
                }
                return response.json();
            })
            .then(data => {
                updateCurrentWeather(data);
                updateHourlyForecast(data);
                updateDailyForecast(data); 
                
                loadingEl.style.display = 'none';
                appEl.style.display = 'block';
            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                loadingEl.innerHTML = `<p class="text-red-500">L·ªói: ${error.message}</p>`;
                loadingEl.style.display = 'block';
                appEl.style.display = 'none';
            });
        }

        // H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN CH√çNH
        function updateCurrentWeather(data) {
            const { current, daily } = data;
            const weather = getWeatherInfo(current.weather_code);

            // C·∫¨P NH·∫¨T N·ªÄN ƒê·ªòNG
            let bgKey = 'day_clear';
            if (weather.category === 'rain') {
                bgKey = 'rain';
            } else if (weather.category === 'cloudy') {
                bgKey = 'cloudy';
            } else if (current.is_day === 0) { // 0 l√† ban ƒë√™m
                bgKey = 'night_clear';
            }
            document.body.style.backgroundImage = backgrounds[bgKey];

            // C·∫≠p nh·∫≠t text
            $('current-temp').textContent = `${Math.round(current.temperature_2m)}¬∞`;
            $('current-desc').textContent = weather.desc;
            
            $('current-high-low').textContent = `Cao: ${Math.round(daily.temperature_2m_max[0])}¬∞ / Th·∫•p: ${Math.round(daily.temperature_2m_min[0])}¬∞`;
            
            $('current-feels-like').textContent = `${Math.round(current.apparent_temperature)}¬∞`;
            $('current-humidity').textContent = `${current.relative_humidity_2m}%`;
            $('current-wind-speed').textContent = `${current.wind_speed_10m.toFixed(1)}`;
            $('current-wind-dir').textContent = `H∆∞·ªõng ${getWindDirection(current.wind_direction_10m)}`; // ƒê√É S·ª¨A L·ªñI
            $('current-rain').textContent = `${current.precipitation.toFixed(1)} mm`;

            $('current-sunrise').textContent = formatTime(daily.sunrise[0]);
            $('current-sunset').textContent = formatTime(daily.sunset[0]);
        }

        // H√ÄM C·∫¨P NH·∫¨T GI·ªú
        function updateHourlyForecast(data) {
            const container = $('hourly-forecast-container');
            container.innerHTML = '';
            const { hourly } = data;
            const now = new Date();
            
            let currentHourIndex = hourly.time.findIndex(timeStr => new Date(timeStr) > now);
            if (currentHourIndex === -1) currentHourIndex = 0; 
            if (currentHourIndex > 0) currentHourIndex--; 

            const next8Hours = hourly.time.slice(currentHourIndex, currentHourIndex + 8);

            next8Hours.forEach((timeStr, index) => {
                const i = currentHourIndex + index;
                const weather = getWeatherInfo(hourly.weather_code[i]);
                const time = formatHour(timeStr);
                const temp = Math.round(hourly.temperature_2m[i]);

                const cardHtml = `
                    <div class="flex-shrink-0 w-20 text-center px-1">
                        <p class="font-medium text-gray-200 text-sm mb-1">${time}</p>
                        <div class="weather-icon-hourly my-2">${weather.icon}</div>
                        <p class="font-bold text-lg">${temp}¬∞</p>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        // H√ÄM C·∫¨P NH·∫¨T NG√ÄY
        function updateDailyForecast(data) {
            const container = $('daily-forecast-container');
            container.innerHTML = '';
            const { daily } = data;

            const weekMin = Math.min(...daily.temperature_2m_min);
            const weekMax = Math.max(...daily.temperature_2m_max);
            const weekRange = weekMax - weekMin;

            daily.time.slice(1, 6).forEach((dateStr, index) => {
                const i = index + 1;
                const weather = getWeatherInfo(daily.weather_code[i]);
                const dayName = (i === 1) ? 'Ng√†y mai' : formatDay(dateStr);
                
                const tempMax = Math.round(daily.temperature_2m_max[i]);
                const tempMin = Math.round(daily.temperature_2m_min[i]);
                const pop = daily.precipitation_probability_max[i];

                let leftPercent = 0;
                let widthPercent = 100;
                if (weekRange > 0) {
                    leftPercent = ((tempMin - weekMin) / weekRange) * 100;
                    widthPercent = ((tempMax - tempMin) / weekRange) * 100;
                }
                
                const cardHtml = `
                    <li class="list-divider flex items-center justify-between py-2.5">
                        <div class="w-1/3 text-base font-medium">${dayName}</div>
                        
                        <div class="w-1/3 flex items-center justify-center">
                            <span class="weather-icon-daily">${weather.icon}</span>
                            <span class="text-xs text-blue-300 font-medium ml-1.5">${pop}%</span>
                        </div>

                        <div class="w-1/3 text-right font-medium flex items-center justify-end">
                            <span class="text-base text-gray-300">${tempMin}¬∞</span>
                            <div class="temp-bar-track mx-2 flex-1">
                                <div class="temp-bar-thumb" style="margin-left: ${leftPercent}%; width: ${widthPercent}%;"></div>
                            </div>
                            <span class="text-base">${tempMax}¬∞</span>
                        </div>
                    </li>
                `;
                container.innerHTML += cardHtml;
            });
        }
    </script>

    <!-- SCRIPT G·ª¨I CHI·ªÄU CAO CHO WORDPRESS (PARENT) -->
    <script>
        function sendHeight() {
            try {
                var height = document.body.scrollHeight;
                window.parent.postMessage({ height: height }, '*');
            } catch(e) {
                console.warn('Kh√¥ng th·ªÉ g·ª≠i chi·ªÅu cao cho parent:', e);
            }
        }
        window.addEventListener('load', sendHeight);
        try {
            let resizeTimer;
            const resizeObserver = new ResizeObserver(() => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(sendHeight, 150);
            });
            resizeObserver.observe(document.body);
        } catch(e) {
            setInterval(sendHeight, 1000);
        }
        setTimeout(sendHeight, 1000);
        setTimeout(sendHeight, 3000);
    </script>

</body>
</html>
